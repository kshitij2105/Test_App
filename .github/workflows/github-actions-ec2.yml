name: Invoke Lambda

on:
  workflow_dispatch:

jobs:
  invoke:
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ap-south-1
      FUNCTION_NAME: Trigger-Backend-Deployment
      PAYLOAD: '{}'

    steps:
      - name: Curl invoke Lambda
        run: |
          SERVICE="lambda"
          HOST="lambda.${AWS_REGION}.amazonaws.com"
          URI="/2015-03-31/functions/${FUNCTION_NAME}/invocations"
          ENDPOINT="https://${HOST}${URI}"

          AMZ_DATE=$(date -u +"%Y%m%dT%H%M%SZ")
          DATE_STAMP=$(date -u +"%Y%m%d")

          hash() {
            printf "%s" "$1" | openssl dgst -sha256 | sed 's/^.* //'
          }

          hmac() {
            printf "%s" "$2" | openssl dgst -sha256 -mac HMAC -macopt "key:$1" | sed 's/^.* //'
          }

          PAYLOAD_HASH=$(hash "$PAYLOAD")

          CANONICAL_REQUEST="POST
${URI}

host:${HOST}
x-amz-date:${AMZ_DATE}

host;x-amz-date
${PAYLOAD_HASH}"

          CANONICAL_HASH=$(printf "%s" "$CANONICAL_REQUEST" | openssl dgst -sha256 | sed 's/^.* //')
          CREDENTIAL_SCOPE="${DATE_STAMP}/${AWS_REGION}/${SERVICE}/aws4_request"
          STRING_TO_SIGN="AWS4-HMAC-SHA256
${AMZ_DATE}
${CREDENTIAL_SCOPE}
${CANONICAL_HASH}"

          K_DATE=$(hmac "AWS4${AWS_SECRET_ACCESS_KEY}" "$DATE_STAMP")
          K_REGION=$(hmac "$K_DATE" "$AWS_REGION")
          K_SERVICE=$(hmac "$K_REGION" "$SERVICE")
          K_SIGNING=$(hmac "$K_SERVICE" "aws4_request")
          SIGNATURE=$(printf "%s" "$STRING_TO_SIGN" | openssl dgst -sha256 -mac HMAC -macopt "key:$K_SIGNING" | sed 's/^.* //')

          AUTH_HEADER="AWS4-HMAC-SHA256 Credential=${AWS_ACCESS_KEY_ID}/${CREDENTIAL_SCOPE}, SignedHeaders=host;x-amz-date, Signature=${SIGNATURE}"

          curl -s -X POST "${ENDPOINT}" \
            -H "Content-Type: application/json" \
            -H "X-Amz-Date: ${AMZ_DATE}" \
            -H "Authorization: ${AUTH_HEADER}" \
            -d "${PAYLOAD}"
